name: PR intake

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  notify-and-validate:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.1.26

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Validate author matches GitHub username
        env:
          EXPECTED_AUTHOR: ${{ github.event.pull_request.user.login }}
          DIFF_BASE: ${{ github.event.pull_request.base.sha }}
          DIFF_HEAD: ${{ github.event.pull_request.head.sha }}
        run: bun run validate:author

      - name: Comment with review guidance
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const marker = "<!-- slop-daily-review-note -->";
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number
            });

            if (comments.some((comment) => comment.body && comment.body.includes(marker))) {
              return;
            }

            const body = `${marker}\nThanks for the submission! This repo is a GitHub intake mirror only. Reviews and merges happen in GitLab, so please wait while we check your PR there. We will follow up once it has been reviewed.`;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body
            });
